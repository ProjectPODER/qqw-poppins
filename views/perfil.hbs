<script src="/tiza/tiza.js"></script>

<section class="profile-header">
  <div class="wrap bg-gray" id="wrap">
    <div class="description-data-title">
      <h3 title="{{ result.compiledRelease.name}}">
        {{{ get_classification_icon type result.compiledRelease.classification result.compiledRelease.subclassification result.compiledRelease.govLevel}}}
        {{ result.compiledRelease.name}}
      </h3>
    </div>
    <div class="profile-breadcrumb">
      <a href="/">Inicio</a> &gt;
      {{#each result.compiledRelease.area }}
        {{#if id }}
          <a href="/regiones/{{id}}">
            {{translate_area id}}
          </a> &gt;
        {{/if}}
      {{/each}}
      <a href="/{{get_type_url type}}">{{ get_classification_name type result.compiledRelease.classification result.compiledRelease.subclassification result.compiledRelease.govLevel }}</a>
    </div>
    <div class="right-box ml-auto filters">
        <ul class="nav nav-pills d-flex flex-nowrap">
            {{>utilities api_url=result.api_url share_url=share_url }}                
        </ul>
    </div>
  </div>
</section>

<nav id="right-menu" class="menu-profile">
  <ul class="right-menu-profile nav-stacked nav">
    {{#if result.summaries.buyer.total.count }}
    <li>
      <a href="#summary-buyer" class="anchor">
        <i class="fas fa-money-check-alt"></i> Compras
      </a>
    </li>
    {{/if}}
    {{#if result.summaries.supplier.total.count }}
    <li>
      <a href="#summary-supplier" class="anchor">
        <i class="fas fa-dolly"></i> Proveedor
      </a>
    </li>
    {{/if}}
    {{#if result.summaries.funder.total.count }}
    <li>
      <a href="#summary-funder" class="anchor">
        <i class="fas fa-donate"></i> Financiación
      </a>
    </li>
    {{/if}}
    {{#ifCond result.summaries.relation.nodes.length ">" 0}}
    <li>
      <a href="#flujos-monetarios" class="anchor">
        <i class="fas fa-chart-pie"></i> Flujos monetarios
      </a>
    </li>
    {{/ifCond}}


    {{#ifCond type '!=' 'companies'}}
    {{#if result.flags }}
    <li>
      <a href="#evaluacion" class="anchor evaluacion">
        <i class="fas fa-file-signature"></i> Evaluación
      </a>
    </li>
    {{/if}}
    {{/ifCond}}


    {{#if result.memberships.parent}}
    {{#each result.memberships.parent }}
    <li>
      <a href="#memberships-parent-{{@index}}" class="anchor">
        {{{get_role_icon this.role this.directionality}}}{{get_role_name this.role this.directionality}}
      </a>
    </li>
    {{/each}}
    {{/if}}
    {{#if result.memberships.child}}
    {{#each result.memberships.child }}
    <li>
      <a href="#memberships-child-{{@index}}" class="anchor">
        {{{get_role_icon this.role this.directionality}}}{{get_role_name this.role this.directionality}}
      </a>
    </li>
    {{/each}}
    {{/if}}
    {{#if result.compiledRelease.area.length }}
    <li>
      <a href="#ubicacion" class="anchor">
        <i class="fas fa-map-marker"></i> Ubicacion
      </a>
    </li>
    {{/if}}

    <li>
      <a href="#informacion-general" class="anchor">
        <i class="fas fa-folder-open"></i> Información
      </a>
    </li>

  </ul>
</nav>


<section class="profile" id="top-nonsense">
  <div class="profile-content">
    <div class="row">
      <div class="col-9 col-m-9">
          {{#ifCond type '==' 'persons'}}
            {{#ifCond result.compiledRelease.contract_count.buyer '>' '0'}}
              <div class="col-12 col-m-12">
                <p class="description-data-amount">Ésta persona es (o ha sido) responsable de una Unidad Compradora y con el objetivo de brindar la máxima información disponible lo mostramos como comprador a todos los contratos que sucedieron bajo su mandato.</p>
              </div>
            {{/ifCond}}
          {{/ifCond}}

        {{#ifCond type "==" "companies"}}
        {{> gender-indicator result_name=result.compiledRelease.name country_data=result.countryData }}
        {{/ifCond}}
      </div>
    </div>
  </div>

</section>


{{!-- Dependencia --}}
{{#if result.membership_uc_child }}
<section class="profile" id="memberships-child-uc">
  <div class="profile-content">
    <div class="row memberships">
      <div class="col-9 col-m-9">
        <div  class=" profile-list">
          <h4 class="description-data-subtitle">
            {{{get_role_icon result.membership_uc_child.role result.membership_uc_child.directionality}}}{{get_role_name result.membership_uc_child.role result.membership_uc_child.directionality}}
          </h4>
          {{#each result.membership_uc_child.memberships}}
            {{>membership result=this directionality=../result.membership_uc_child.directionality}}
          {{/each}}
        </div>
      </div>
    </div>
  </div>
</section>
{{/if}}

{{!-- SUMMARIES --}}
{{#if result.summaries.buyer.total.count }}
{{>summary result=result summary="buyer" data=result.summaries.buyer }}
{{/if}}

{{!-- Unidades compradoras --}}
{{#if result.membership_uc_parent }}
<section class="profile" id="memberships-parent-uc">
  <div class="profile-content">
    <div class="row memberships">
      <div class="col-9 col-m-9">
        <div  class=" profile-list">
          <h4 class="description-data-subtitle">
            {{{get_role_icon result.membership_uc_parent.role result.membership_uc_parent.directionality}}}{{get_role_name result.membership_uc_parent.role result.membership_uc_parent.directionality}}
          </h4>
          {{#each result.membership_uc_parent.memberships}}
            {{>membership result=this directionality=../result.membership_uc_parent.directionality}}
          {{/each}}
        </div>
      </div>
    </div>
  </div>
</section>
{{/if}}



{{#if result.summaries.supplier.total.count }}
{{>summary result=result summary="supplier" data=result.summaries.supplier }}
{{/if}}

{{#if result.summaries.funder.total.count }}
{{>summary result=result summary="funder" data=result.summaries.funder }}
{{/if}}


{{#ifCond result.summaries.relation.nodes.length ">" 0}}
<section class="profile" id="flujos-monetarios">
  <div class="profile-content">
    <div class="row">
      <div  class="col-m-9 col-9">
        <div class="col-m-12 col-12">
          <h4 class="description-data-subtitle"><i class="fas fa-chart-pie"></i> FLUJOS MONETARIOS</h4>
          <div id="graph-container">
          </div>
        </div>
        <div class="col-12">
          <hr>
        </div>
      </div>
    </div>
  </div>
</section>
{{/ifCond}}

<script>
  tiza.moneyFlow({target: "graph-container", data: {{{j result.summaries.relation}}} });
</script>


{{#ifCond type '!=' 'companies'}}
{{#if result.flags }}
<section class="profile" id="evaluacion">
  <div class="profile-content">
    <div class="row">
      <div  class="col-m-9 col-9" bg-gray>
        <div class="row">
          <div class="col-6 col-m-6">
            <h4 class="description-data-subtitle"><i class="fas fa-file-signature"></i> EVALUACIÓN Y RECOMENDACIONES</h4>
          </div>
          <div class="col-m-6 col-6 text-right-">
            <h4 class="amount-data">
              Puntaje total: {{ format_score result.flags.0.total_score }}
            </h4>
          </div>
          <div class="col-12 col-m-12">
            <p>A partir de 25 pruebas algorítmicas, que agrupamos en cinco grandes categorías, determinamos la calidad de los datos de contratación que introduce cada dependencia y unidad compradora. Para la puntuación final el sistema también tiene en cuenta la puntuación de las dependencias con quién se relaciona de forma indirecta. La metodología puede consultarse en <a href="https://www.TodosLosContratos.mx/#metodologia">TodosLosContratos.mx</a>.</p>
          </div>
        </div>
        <div class="col-12-col-m-12">
          {{#each (get_party_categories result.flags.[0]) }}
          <div class="flags_graph_bar">
            <div class="flag_name">
               {{#with (flag_name @key) }}
                  {{name}} 
                  <a data-toggle="tooltip" data-placement="right" title="{{info}}">
                    <i class="fas fa-info"></i>
                  </a>
               {{/with}}
            </div>
              <div class="flag_pole flag_{{@key}}">
                <div class="flag_pole_min" style="width: {{format_score (party_category_min @key)}}">
                </div>
                <div class="flag_pole_max" style="width: {{format_score (math 1 "-" (party_category_max @key))}}">
                </div>
                <div class="flag_marker" style="left: {{format_score this}}">
                  {{format_score this}}
                </div>
              </div>
          </div>
          {{/each}}
          <div class="col-12-col-m-12 mt-60">
            {{# each (flag_recommendations result.flags flag_count) }}
            <div class="col-4 col-m-12 category-profile">
              <p><b>Categoría:</b> {{category}}</p>
              <p><b>Problema:</b> {{description}}</p>
              <p><b>Puntaje:</b> {{format_score score }}</p>
              <p><b>Recomendación:</b> {{uc_string}}</p>
            </div>
            {{/each}}
          </div>
      </div>
      <div class="col-12 text-center">
          <button class="btn button-link" onclick="$('#profile-send-info').toggle()">Solcitar informe detallado</button>
      </div>
      </div>
    </div>
    <div class="row" style="display: none" id="profile-send-info">
      <div  class="col-m-9 col-9">
        <div  class="">
          <h3>Solicitar más información</h3>
          <p>Con el objetivo de que las dependencias y las Unidades Compradoras puedan mejorar la calidad de los datos de contrataciones destacamos las tres banderas que dieron un resultado más bajo y como pueden mejorar. Para tener la lista completa contáctanos a través del formulario. </p>
          <form class="sendinfo-form mt-2">
            <fieldset>
              <div class="form-group" data-required="true">
                <label for="name" class="control-label"><b>Nombre</b></label>
                <input type="text" name="name" id="name" maxlength="50" class="form-control">
                <span class="help-block"></span>
              </div>
              <div class="form-group">
                <label for="institution" class="control-label"><b>Institución</b></label>
                <input type="text" name="subject" id="institution" class="form-control">
                <span class="help-block"></span>
              </div>
              <div class="form-group" data-required="true">
                <label for="email" class="control-label"><b>Correo electrónico</b></label>
                <input id="email" type="email" name="contact-email" class="form-control">
                <span class="help-block"></span>
              </div>
            </fieldset>
            <input id="uc_id_message" type="hidden" name="message" value="{{result.id}}">
            <div class="centered">
                <button id="send_info_uc" type="submit" class="btn button-link contact-submit">Enviar</button>
            </div>
          </form>
          <div id="thanks-column" style="display: none;" class="mt-2">
            <h4>Mensaje enviado</h4>
            <p>Muchas gracias, pronto le enviaremos la información correspondiente.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
{{/if}}
{{/ifCond}}


{{!-- memberships --}}
<div class="profile-content">
  <div class="row memberships">
    <div class="col-9 col-m-9">
      {{#if result.memberships.parent}}
        {{#each result.memberships.parent }}
        <section class="profile" id="memberships-parent-{{@index}}">
          <div  class=" profile-list">
            <h4 class="description-data-subtitle">
              {{{get_role_icon this.role this.directionality}}}{{get_role_name this.role this.directionality}}
            </h4>
            {{#each this.memberships}}
              {{>membership result=this directionality=../directionality}}
            {{/each}}
          </div>
        </section>
        {{/each}}
      {{/if}}

      {{#if result.memberships.child}}
        {{#each result.memberships.child }}
        <section class="profile" id="memberships-child-{{@index}}">
          <div class="profile-list">
            <h4 class="description-data-subtitle">
              {{{get_role_icon this.role this.directionality}}}{{get_role_name this.role this.directionality}}
            </h4>
            {{#each this.memberships}}
              {{>membership result=this directionality=../directionality }}
            {{/each}}
          </div>
        </section>
        {{/each}}
      {{/if}}
    </div>
  </div>
</div>

{{#if result.compiledRelease.area.length }}
<section class="profile" id="ubicacion">
  <div class="profile-content">
    <div class="row">

      <div class="col-9 col-m-9">
        <h4 class="description-data-subtitle"><i class="fas fa-map-marker"></i> Ubicación</h4>
        <div class="row flex">

          {{#each result.compiledRelease.area }}
              <div class="col-m-1 col-1 pd-nonleft">
                <p class="js-title-data">
                  {{#ifCond classification '==' 'country'}}País
                    {{#ifCond subclassification '==' 'country-born'}}de nacimiento{{/ifCond}}
                    {{#ifCond subclassification '==' 'country-of-residence'}}de residencia{{/ifCond}}
                  {{/ifCond}}
                  {{#ifCond classification '==' 'city'}}Ciudad{{/ifCond}}
                  {{#ifCond classification '==' 'region'}}Región{{/ifCond}}
                  {{#ifCond classification '==' 'state'}}Estado{{/ifCond}}
                </p>
                <p class="js-data">
                  {{translate_area id}}
                </p>
              </div>
          {{/each}}
        </div>

      </div>
    </div>
  </div>

</section>
{{/if}}

{{!-- info --}}
<section class="profile" id="informacion-general">
  <div class="profile-content">
    <div class="row">

      <div class="col-9 col-m-9">
        <h4 class="description-data-subtitle"><i class="fas fa-folder-open"></i> INFORMACIÓN GENERAL</h4>
        <div class="row flex">

          {{#if result.compiledRelease.other_names.length }}
            <div class="col-m-5 col-5 pd-nonleft">
              <p class="js-title-data">Nombres alternativos</p>
              <ul class="js-data">
                {{#each result.compiledRelease.other_names}}
                <li class="{{#ifCond @index ">" 2}}profile-list-hidden{{/ifCond}}">
                    {{name}}
                </li>
                {{/each}}
              </ul>
              {{#ifCond result.compiledRelease.other_names.length '>' 2}}
              <div style="margin-top: 1rem; margin-bottom: 0.5rem">
              <a class="profile-list-toggle">Ver todos ({{result.compiledRelease.other_names.length}})</a>
              </div>
              {{/ifCond}}
            </div>
          {{/if}}


          {{#if result.compiledRelease.subclassification}}
            <div class="col-m-3 col-3">
              <p class="js-title-data">Tipo de entidad</p>
              <p class="js-data">{{result.compiledRelease.subclassification}}</p>
            </div>
          {{/if}}

          {{#if result.compiledRelease.identifiers }}
            <div class="col-m-3 col-3 pd-nonleft">
              <p class="js-title-data">Identificadores</p>
              {{#each result.compiledRelease.identifiers}}
                <p class="js-data">
                  {{#ifCond identifier '!=' '#ĦVALOR!'}}
                    {{#ifCond scheme '!=' 'CIQ'}}
                      {{scheme}}: {{id}}{{identifier}}
                    {{/ifCond}}
                  {{/ifCond}}

                  {{#ifCond scheme '==' 'RUPC'}} <a data-toggle="tooltip" data-placement="right" title="Folio asignado por la SFP a la persona física o moral que fue inscrita al Registro Único de Registro Único de Proveedores y Contratistas (RUPC) por un ente público con el que celebró algún contrato"><img src="../images/icons/info.svg" alt="icon" class="info-icon"></a>{{/ifCond}}
                {{/each}}</p>
            </div>
          {{/if}}

          {{#if result.compiledRelease.links}}
            <div class="col-m-3 col-3 pd-nonleft">
              <p class="js-title-data">Link(s)</p>
              {{#each result.compiledRelease.links}}
                <p class="js-data"><a href="{{this.id}}" target="_blank">{{this.id}}</a></p>
              {{/each}}
            </div>
          {{/if}}

        </div>

        <div class="row flex">
          {{#if result.compiledRelease.date}}
            <div class="col-m-3 col-3 pd-nonleft">
              <p class="js-title-data">Fecha de actualización</p>
              <p class="js-data">{{moment result.compiledRelease.date date lang="es" format="LL"}}</p>
            </div>
          {{/if}}

          {{#if result.compiledRelease.source}}
            <div class="col-m-3 col-3 pd-nonleft">
              <p class="js-title-data">Fuente(s)</p>
              <p class="js-data">{{#each result.compiledRelease.source}} <a href="/entidades-y-fuentes#{{this.id}}">{{this.id}}</a>{{#if @last}}{{else}}, {{/if}}{{/each}}</p>
            </div>
          {{/if}}
        </div>

      </div>
    </div>
  </div>

</section>
